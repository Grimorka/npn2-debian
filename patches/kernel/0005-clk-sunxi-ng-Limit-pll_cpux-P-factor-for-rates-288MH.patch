From 7d7edef9b4ab1116dacb8ce45c0284e402fbe9c5 Mon Sep 17 00:00:00 2001
From: Chris Blake <chrisrblake93@gmail.com>
Date: Mon, 25 Jun 2018 08:51:29 -0500
Subject: [PATCH 5/8] clk: sunxi-ng: Limit pll_cpux P factor for rates > 288MHz
 on H3

Kangd from
https://github.com/megous/linux/commit/30deeee551ccf10b03c79f9e3a6a07504f2bfc0d
---
 drivers/clk/sunxi-ng/ccu-sun8i-h3.c | 25 +++++++++++++------------
 1 file changed, 13 insertions(+), 12 deletions(-)

diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-h3.c b/drivers/clk/sunxi-ng/ccu-sun8i-h3.c
index a385f42..9f89ef6 100644
--- a/drivers/clk/sunxi-ng/ccu-sun8i-h3.c
+++ b/drivers/clk/sunxi-ng/ccu-sun8i-h3.c
@@ -31,18 +31,19 @@
 #include "ccu-sun8i-h3.h"
 
 static struct ccu_nkmp pll_cpux_clk = {
-	.enable		= BIT(31),
-	.lock		= BIT(28),
-	.n			= _SUNXI_CCU_MULT(8, 5),
-	.k			= _SUNXI_CCU_MULT(4, 2),
-	.m			= _SUNXI_CCU_DIV_MAX(0, 2, 1),
-	.p			= _SUNXI_CCU_DIV(16, 2),
-	.common		= {
-		.reg		= 0x000,
-		.hw.init	= CLK_HW_INIT("pll-cpux",
-								"osc24M",
-								&ccu_nkmp_ops,
-					      		CLK_SET_RATE_UNGATE),
+	.enable			= BIT(31),
+	.lock			= BIT(28),
+	.n				= _SUNXI_CCU_MULT(8, 5),
+	.k				= _SUNXI_CCU_MULT(4, 2),
+	.m				= _SUNXI_CCU_DIV_MAX(0, 2, 1),
+	.p				= _SUNXI_CCU_DIV(16, 2),
+	.max_rate_for_p = 288000000,
+	.common			= {
+		.reg			= 0x000,
+		.hw.init		= CLK_HW_INIT("pll-cpux",
+									"osc24M",
+									&ccu_nkmp_ops,
+					      			CLK_SET_RATE_UNGATE),
 	},
 };
 
-- 
2.7.4

